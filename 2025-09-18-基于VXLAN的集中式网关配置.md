---
title: 基于VXLAN的集中式网关配置
author: Izumi
date: 2025-09-18
---

# 基于VXLAN的集中式网关

[TOC]

## 基于IPv4的VXLAN，静态方式，集中式网关

### 网络规划

* 网络拓扑图

  ![image-20250917155254220](https://raw.githubusercontent.com/kurala719/images/master/image-20250917155254220.png)

* 设备基础信息规划表

  | Device | Interface | Type |  IPv4 Address   | VLAN |
  | :----: | :-------: | :--: | :-------------: | :--: |
  |  CE-1  |  GE1/0/8  |  L3  |   10.1.0.9/30   |  /   |
  |        |  GE1/0/9  |  L3  |   10.1.0.5/30   |  /   |
  |        | GE1/0/10  |  L3  |   10.1.0.1/30   |  /   |
  |        | Loopback0 |  L3  |   10.0.0.1/32   |  /   |
  |  CE-2  |  GE1/0/1  |  L3  |   10.1.0.2/30   |  /   |
  |        | GE1/0/10  |  L2  |        /        |  10  |
  |        | Loopback0 |  L3  |   10.0.0.2/32   |  /   |
  |  CE-3  |  GE1/0/1  |  L3  |   10.1.0.6/30   |  /   |
  |        | GE1/0/10  |  L2  |        /        |  10  |
  |        | Loopback0 |  L3  |   10.0.0.3/32   |  /   |
  |  CE-4  |  GE1/0/1  |  L3  |  10.1.0.10/30   |  /   |
  |        | GE1/0/10  |  L2  |        /        |  20  |
  |        | Loopback0 |  L3  |   10.0.0.4/32   |  /   |
  |  PC-1  |  GE1/0/0  |  L3  | 192.168.10.1/24 |  10  |
  |  PC-2  |  GE1/0/0  |  L3  | 192.168.10.2/24 |  10  |
  |  PC-3  |  GE1/0/0  |  L3  | 192.168.20.1/24 |  10  |

* IS-IS规划表

  | Device | IS-IS Process |            NET            |               Interface               |
  | :----: | :-----------: | :-----------------------: | :-----------------------------------: |
  |  CE-1  |       1       | 49.0001.0100.0000.0001.00 | GE1/0/8, GE1/0/9, GE1/0/10, Loopback0 |
  |  CE-2  |       1       | 49.0001.0100.0000.0002.00 |          GE1/0/1, Loopback0           |
  |  CE-3  |       1       | 49.0001.0100.0000.0003.00 |          GE1/0/1, Loopback0           |
  |  CE-4  |       1       | 49.0001.0100.0000.0004.00 |          GE1/0/1, Loopback0           |

* VXLAN规划表

  | Device |  BD  |       VBDIF       | VNI  |
  | :----: | :--: | :---------------: | :--: |
  |  CE-1  |  10  | 192.168.10.254/24 |  10  |
  |        |  20  | 192.168.20.254/24 |  20  |
  |  CE-2  |  10  |         /         |  10  |
  |  CE-3  |  10  |         /         |  10  |
  |  CE-4  |  20  |         /         |  20  |

* 配置思路

  如上所示，在本次实验中，我们使用华为*eNSP Pro*云实验平台，交换机型号为*CE6800*，以*ISIS*构建底层*Underlay网络*，以*VXLAN*构建*Overlay网络*。其中*CE-2*、*CE-3*和*CE-4*分别作为VXLAN的*接入点*，通过在*CE-2*和*CE-3*之间建立VXLAN隧道透传*同子网*的二层报文，通过将*CE-1*作为接入设备的*网关*以传输*不同子网*的VXLAN报文。

### 配置步骤

#### 1. 配置设备的基础信息

* CE-1

  ```
  sy
  int g1/0/8
  undo ports
  ip add 10.1.0.9 30
  int g1/0/9
  undo ports
  ip add 10.1.0.5 30
  int g1/0/10
  undo ports
  ip add 10.1.0.1 30
  int l0
  ip add 10.0.0.1 32
  commit
  ```

* CE-2

  ```
  sy
  vl b 10
  int g1/0/1
  undo ports
  ip add 10.1.0.2 30
  int g1/0/10
  p l a
  p d v 10
  int l0
  ip add 10.0.0.2 32
  commit
  ```

* CE-3

  ```
  sy
  vl 10
  int g1/0/1
  undo ports
  ip add 10.1.0.6 30
  int g1/0/10
  p l a
  p d v 10
  int l0
  ip add 10.0.0.3 32
  commit
  ```

* CE-4

  ```
  sy
  vl 20
  int g1/0/1
  undo ports
  ip add 10.1.0.10 30
  int g1/0/10
  p l a
  p d v 20
  int l0
  ip add 10.0.0.4 32
  commit
  ```

#### 2. 配置IS-IS

* CE-1

  ```
  isis 1
  net 49.0001.0100.0000.0001.00
  int g1/0/8
  is e 1
  int g1/0/9
  is e 1
  int g1/0/10
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-2

  ```
  isis 1
  net 49.0001.0100.0000.0002.00
  int g1/0/1
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-3

  ```
  isis 1
  net 49.0001.0100.0000.0003.00
  int g1/0/1
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-4

  ```
  isis 1
  net 49.0001.0100.0000.0004.00
  int g1/0/1
  is e 1
  int l0
  is e 1
  commit
  ```

#### 3. 配置VXLAN

* CE-1

  ```
  bridge-domain 10
  vxlan vni 10
  bridge-domain 20
  vxlan vni 20
  interface vbdif 10
  ip add 192.168.10.254 24
  interface vbdif 20
  ip add 192.168.20.254 24
  interface nve 1
  source 10.0.0.1
  vni 10 head-end peer-list 10.0.0.2 10.0.0.3
  vni 20 head-end peer-list 10.0.0.4
  commit
  ```

* CE-2

  ```
  bridge-domain 10
  l2 binding vlan 10
  vxlan vni 10
  interface nve 1
  source 10.0.0.2
  vni 10 head-end peer-list 10.0.0.1 10.0.0.3
  commit
  ```

* CE-3

  ```
  bridge-domain 10
  l2 binding vlan 10
  vxlan vni 10
  interface nve 1
  source 10.0.0.3
  vni 10 head-end peer-list 10.0.0.1 10.0.0.2
  commit
  ```

* CE-4

  ```
  bridge-domain 20
  l2 binding vlan 20
  vxlan vni 20
  interface nve 1
  source 10.0.0.4
  vni 20 head-end peer-list 10.0.0.1
  commit
  ```

### 验证结果

* [ ] 检查网络设备的基础信息配置（使用命令`dis ip int b`、`dis ip route`、`dis vlan`）

* [ ] 检查ISIS的配置（使用命令`dis isis pe`、`dis isis route`、`dis isis int`）

* [ ] 检查VXLAN配置

  * [ ] 执行命令`display bridge-domain [ binding-info | bd-id [ brief | verbose | binding-info ] ]`，查看广播域BD的配置信息。
  * [ ] 执行命令`display interface nve [ nve-number | main ]`，查看NVE接口的状态信息。
  * [ ] 执行命令`display vxlan peer [ vni vni-id ]`，查看配置的VNI的头端复制列表信息。
  * [ ] 执行命令`display vxlan tunnel [ tunnel-id ] [ verbose ]`，查看VXLAN隧道的信息。
  * [ ] 执行命令`display vxlan vni [ vni-id [ verbose ] ]`，查看VXLAN的配置信息及VNI状态。
  * [ ] 执行命令`display interface vbdif [ bd-id ]`，查看VBDIF接口的状态信息、配置信息和统计信息。

* [ ] 检查设备之间的通信情况

  * [ ] 使用CE-1 ping CE-2：`ping -a 10.0.0.1 10.0.0.2`
  * [ ] 使用CE-2 ping CE-3：`ping -a 10.0.0.2 10.0.0.3`
  * [ ] 使用CE-2 ping CE-4：`ping -a 10.0.0.2 10.0.0.4`

  * [ ] 使用PC-1 ping PC-2：`ping 192.168.10.2`
  * [ ] 使用PC-1 ping PC-3：`ping 192.168.20.1`

## 基于IPv4的VXLAN，EVPN方式，集中式网关

### 网络规划

* 网络拓扑图

  ![image-20250917154710169](https://raw.githubusercontent.com/kurala719/images/master/image-20250917154710169.png)

* 设备基础信息规划表

  | Device | Interface  | Type |  IPv4 Address   |
  | :----: | :--------: | :--: | :-------------: |
  |  NE-1  |  GE3/0/7   |  L3  |   10.1.0.9/30   |
  |        |  GE3/0/8   |  L3  |   10.1.0.5/30   |
  |        |  GE3/0/9   |  L3  |   10.1.0.1/30   |
  |        | Loopback0  |  L3  |   10.0.0.1/32   |
  |  NE-2  |  GE3/0/0   |  L3  |   10.1.0.2/30   |
  |        | GE3/0/9.10 |  L2  |        /        |
  |        | Loopback0  |  L3  |   10.0.0.2/32   |
  |  NE-3  |  GE3/0/0   |  L3  |   10.1.0.6/30   |
  |        | GE3/0/9.10 |  L2  |        /        |
  |        | Loopback0  |  L3  |   10.0.0.3/32   |
  |  NE-4  |  GE3/0/0   |  L3  |  10.1.0.10/30   |
  |        | GE3/0/9.20 |  L2  |        /        |
  |        | Loopback0  |  L3  |   10.0.0.4/32   |
  |  PC-1  |  GE1/0/0   |  L3  | 192.168.10.1/24 |
  |  PC-2  |  GE1/0/0   |  L3  | 192.168.10.2/24 |
  |  PC-3  |  GE1/0/0   |  L3  | 192.168.20.1/24 |

* IS-IS规划表

  | Device | IS-IS Process |            NET            |              Interface               |
  | :----: | :-----------: | :-----------------------: | :----------------------------------: |
  |  NE-1  |       1       | 49.0001.0100.0000.0001.00 | GE3/0/7, GE3/0/8, GE3/0/9, Loopback0 |
  |  NE-2  |       1       | 49.0001.0100.0000.0002.00 |          GE3/0/0, Loopback0          |
  |  NE-3  |       1       | 49.0001.0100.0000.0003.00 |          GE3/0/0, Loopback0          |
  |  NE-4  |       1       | 49.0001.0100.0000.0004.00 |          GE3/0/0, Loopback0          |

* BGP规划表

  | 设备 | BGP AS | Peer                         |
  | ---- | ------ | ---------------------------- |
  | NE-1 | 65000  | 10.0.0.2, 10.0.0.3, 10.0.0.4 |
  | NE-2 | 65000  | 10.0.0.1, 10.0.0.3           |
  | NE-3 | 65000  | 10.0.0.1, 10.0.0.2           |
  | NE-4 | 65000  | 10.0.0.1                     |

* EVPN规划表

  | 设备 | EVPN Instance | RD   | IRT   | ERT   | BD   |
  | ---- | ------------- | ---- | ----- | ----- | ---- |
  | NE-1 | VPN_A         | 1:10 | 10:10 | 10:10 | 10   |
  |      | VPN_B         | 1:20 | 20:20 | 20:20 | 20   |
  | NE-2 | VPN_A         | 1:10 | 10:10 | 10:10 | 10   |
  | NE-3 | VPN_A         | 1:10 | 10:10 | 10:10 | 10   |
  | NE-4 | VPN_B         | 1:20 | 20:20 | 20:20 | 20   |

* VXLAN规划表

  | Device |  BD  |       VBDIF       | VNI  |
  | :----: | :--: | :---------------: | :--: |
  |  NE-1  |  10  | 192.168.10.254/24 |  10  |
  |        |  20  | 192.168.20.254/24 |  20  |
  |  NE-2  |  10  |         /         |  10  |
  |  NE-3  |  10  |         /         |  10  |
  |  NE-4  |  20  |         /         |  20  |

* 配置思路

  与前者相似，这里我们采用*EVPN*作为控制平面指导流量转发。由于*eNSP Pro*的固有问题，我们无法使用*CE*设备模拟*EVPN*，故而这里我们使用*NE*设备做集中式网关的配置。**请注意由于产品型号不同，以下许多配置命令与前一实验中的有所区别**。

### 配置步骤

#### 1. 配置设备的基础信息

* CE-1

  ```
  sy
  int g3/0/7
  ip add 10.1.0.9 30
  int g3/0/8
  ip add 10.1.0.5 30
  int g3/0/9
  ip add 10.1.0.1 30
  int l0
  ip add 10.0.0.1 32
  commit
  ```

* CE-2

  ```
  sy
  int g3/0/0
  ip add 10.1.0.2 30
  int g3/0/9.10 mode l2
  encapsulation untag
  int l0
  ip add 10.0.0.2 32
  commit
  ```

* CE-3

  ```
  sy
  int g3/0/0
  ip add 10.1.0.6 30
  int g3/0/9.10 mode l2
  encapsulation untag
  int l0
  ip add 10.0.0.3 32
  commit
  ```

* CE-4

  ```
  sy
  int g3/0/0
  ip add 10.1.0.10 30
  int g3/0/9.20 mode l2
  encapsulation untag
  int l0
  ip add 10.0.0.4 32
  commit
  ```

#### 2. 配置IS-IS

* CE-1

  ```
  isis 1
  net 49.0001.0100.0000.0001.00
  int g3/0/7
  is e 1
  int g3/0/8
  is e 1
  int g3/0/9
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-2

  ```
  isis 1
  net 49.0001.0100.0000.0002.00
  int g3/0/0
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-3

  ```
  isis 1
  net 49.0001.0100.0000.0003.00
  int g3/0/0
  is e 1
  int l0
  is e 1
  commit
  ```

* CE-4

  ```
  isis 1
  net 49.0001.0100.0000.0004.00
  int g3/0/0
  is e 1
  int l0
  is e 1
  commit
  ```

#### 3. 配置BGP

* CE-1

  ```
  bgp 65000
  peer 10.0.0.2 as 65000
  peer 10.0.0.2 con l0
  peer 10.0.0.3 as 65000
  peer 10.0.0.3 con l0
  peer 10.0.0.4 as 65000
  peer 10.0.0.4 con l0
  l2vpn-family evpn
  peer 10.0.0.2 en
  y
  peer 10.0.0.3 en
  y
  peer 10.0.0.4 en
  y
  peer 10.0.0.2 advertise encap-type vxlan
  peer 10.0.0.3 advertise encap-type vxlan
  peer 10.0.0.4 advertise encap-type vxlan
  commit
  ```

* CE-2

  ```
  bgp 65000
  peer 10.0.0.1 as 65000
  peer 10.0.0.1 con l0
  peer 10.0.0.3 as 65000
  peer 10.0.0.3 con l0
  l2vpn-family evpn
  peer 10.0.0.1 en
  y
  peer 10.0.0.3 en
  y
  peer 10.0.0.1 advertise encap-type vxlan
  peer 10.0.0.3 advertise encap-type vxlan
  commit
  ```

* CE-3

  ```
  bgp 65000
  peer 10.0.0.1 as 65000
  peer 10.0.0.1 con l0
  peer 10.0.0.2 as 65000
  peer 10.0.0.2 con l0
  l2vpn-family evpn
  peer 10.0.0.1 en
  y
  peer 10.0.0.2 en
  y
  peer 10.0.0.1 advertise encap-type vxlan
  peer 10.0.0.2 advertise encap-type vxlan
  commit
  ```

* CE-4

  ```
  bgp 65000
  peer 10.0.0.1 as 65000
  peer 10.0.0.1 con l0
  l2vpn-family evpn
  peer 10.0.0.1 en
  y
  peer 10.0.0.1 advertise encap-type vxlan
  commit
  ```

#### 4. 配置EVPN实例

* CE-1

  ```
  evpn vpn-instance VPN_A bd-mode
  route-distinguisher 1:10
  vpn-target 10:10
  evpn vpn-instance VPN_B bd-mode
  route-distinguisher 1:20
  vpn-target 20:20
  commit
  ```

* CE-2

  ```
  evpn vpn-instance VPN_A bd-mode
  route-distinguisher 1:10
  vpn-target 10:10
  commit
  ```

* CE-3

  ```
  evpn vpn-instance VPN_A bd-mode
  route-distinguisher 1:10
  vpn-target 10:10
  commit
  ```

* CE-4

  ```
  evpn vpn-instance VPN_B bd-mode
  route-distinguisher 1:20
  vpn-target 20:20
  commit
  ```

#### 5. 配置VXLAN

* CE-1

  ```
  bridge-domain 10
  vxlan vni 10 split-horizon-mode
  evpn bind vpn VPN_A
  bridge-domain 20
  vxlan vni 20 split-horizon-mode
  evpn bind vpn VPN_B
  interface vbdif 10
  ip add 192.168.10.254 24
  interface vbdif 20
  ip add 192.168.20.254 24
  interface nve 1
  source 10.0.0.1
  vni 10 head-end peer-list protocol bgp
  vni 20 head-end peer-list protocol bgp
  commit
  ```

* CE-2

  ```
  bridge-domain 10
  vxlan vni 10 split-horizon-mode
  evpn bind vpn VPN_A
  interface nve 1
  source 10.0.0.2
  vni 10 head-end peer-list protocol bgp
  int g3/0/9.10
  bridge-domain 10
  commit
  ```

* CE-3

  ```
  bridge-domain 10
  vxlan vni 10 split-horizon-mode
  evpn bind vpn VPN_A
  interface nve 1
  source 10.0.0.3
  vni 10 head-end peer-list protocol bgp
  int g3/0/9.10
  bridge-domain 10
  commit
  ```

* CE-4

  ```
  bridge-domain 20
  vxlan vni 20 split-horizon-mode
  evpn bind vpn VPN_B
  interface nve 1
  source 10.0.0.4
  vni 20 head-end peer-list protocol bgp
  int g3/0/9.20
  bridge-domain 20
  commit
  ```

### 验证结果

* [ ] 检查网络设备的基础信息配置（使用命令`dis ip int b`、`dis ip route`、`dis vlan`）

* [ ] 检查ISIS的配置（使用命令`dis isis pe`、`dis isis route`、`dis isis int`）

* [ ] 检查VXLAN配置

  * [ ] 执行命令`display bridge-domain [ binding-info | bd-id [ brief | verbose | binding-info ] ]`，查看广播域BD的配置信息。
  * [ ] 执行命令`display interface nve [ nve-number | main ]`，查看NVE接口的状态信息。
  * [ ] 执行命令`display vxlan peer [ vni vni-id ]`，查看配置的VNI的头端复制列表信息。
  * [ ] 执行命令`display vxlan tunnel [ tunnel-id ] [ verbose ]`，查看VXLAN隧道的信息。
  * [ ] 执行命令`display vxlan vni [ vni-id [ verbose ] ]`，查看VXLAN的配置信息及VNI状态。
  * [ ] 执行命令`display interface vbdif [ bd-id ]`，查看VBDIF接口的状态信息、配置信息和统计信息。
  * [ ] 执行命令`display bgp evpn peer [ [ ipv4-address ] verbose ]`，查看BGP EVPN对等体信息。
  * [ ] 执行命令`display bgp evpn all routing-table`，可以查看EVPN路由信息。

* [ ] 检查设备之间的通信情况

  * [ ] 使用CE-1 ping CE-2：`ping -a 10.0.0.1 10.0.0.2`
  * [ ] 使用CE-2 ping CE-3：`ping -a 10.0.0.2 10.0.0.3`
  * [ ] 使用CE-2 ping CE-4：`ping -a 10.0.0.2 10.0.0.4`

  * [ ] 使用PC-1 ping PC-2：`ping 192.168.10.2`
  * [ ] 使用PC-1 ping PC-3：`ping 192.168.20.1`

## 附言

笔者本来也想将分布式网关的配置一并付上，但奈何笔者根据产品手册配置后，始终无法达成实验目标，不知道是笔者的问题还是模拟器的问题，故只能将原来写好的内容都删除了，请诸位读者见谅。总之分布式网关的内容笔者将在完成实验后再来谈一谈，不过笔者可能会先给出EVPN的学习内容。
